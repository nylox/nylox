#!/bin/bash

export IFACE_PREFIX="{{ interface_name_prefix | default('eth') }}"
export IFACE_FILE=/etc/udev/rules.d/70-persistent-net.rules
echo "# Munio interfaces configuration - generated by '${0}'" | tee ${IFACE_FILE}

unset MACZ
export MACZ_UNSORTED=""
export IFACEZ=$(ls /sys/class/net)
for iface in ${IFACEZ}
do
  export MAC=$(ethtool --show-permaddr ${iface} 2>/dev/null | awk '{print $3}')
  if [[ "x${MAC}" != "x00:00:00:00:00:00" ]]; then
    MACZ_UNSORTED="${MACZ_UNSORTED} ${MAC}"
  fi
done

# Set virtual MACs
for mac in $MACZ_UNSORTED
do
  if [[ $mac == *"52:54"* ]]; then
    export MACZ="${MACZ} $mac"
  fi
done

COUNTER=0
for mac in $MACZ
do
  name=${IFACE_PREFIX}${COUNTER}
  echo "SUBSYSTEM==\"net\", ACTION==\"add\", DRIVERS==\"?*\", ATTR{address}==\"${mac}\", ATTR{dev_id}==\"0x0\", ATTR{type}==\"1\", NAME=\"$name\"" >> ${IFACE_FILE}
  let COUNTER++
done

exit 0
